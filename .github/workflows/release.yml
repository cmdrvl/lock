name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: Cargo package version to release (for example 0.1.1)
        required: true
        type: string
      publish:
        description: Publish to crates.io after successful dry-run verification
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  id-token: write
  attestations: write

jobs:
  preflight:
    name: Release preflight checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install stable Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2

      - name: Ensure requested version matches Cargo.toml
        shell: bash
        run: |
          set -euo pipefail
          declared_version="$(grep -m1 '^version = "' Cargo.toml | sed 's/version = "\(.*\)"/\1/')"
          requested_version="${{ github.event.inputs.version }}"
          if [[ -z "${declared_version}" ]]; then
            echo "Unable to read package version from Cargo.toml"
            exit 1
          fi
          if [[ "${declared_version}" != "${requested_version}" ]]; then
            echo "Version mismatch: Cargo.toml=${declared_version}, workflow input=${requested_version}"
            exit 1
          fi

      - name: Verify Cargo.lock is synchronized
        run: cargo check --locked --all-targets

      - name: Enforce formatting
        run: cargo fmt --check

      - name: Enforce clippy warnings as errors
        run: cargo clippy --all-targets -- -D warnings

      - name: Run tests
        run: cargo test

      - name: Verify publish artifact with dry-run
        run: cargo publish --dry-run --locked

  build:
    name: Build ${{ matrix.target }}
    needs: preflight
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            archive: tar.gz
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            archive: tar.gz
            cross: true
          - target: x86_64-apple-darwin
            os: macos-13
            archive: tar.gz
          - target: aarch64-apple-darwin
            os: macos-14
            archive: tar.gz
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            archive: zip
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install stable Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target }}

      - name: Install cross (Linux aarch64)
        if: matrix.cross
        uses: taiki-e/install-action@cross

      - name: Build release binary
        shell: bash
        run: |
          if [[ "${{ matrix.cross }}" == "true" ]]; then
            cross build --release --locked --target "${{ matrix.target }}"
          else
            cargo build --release --locked --target "${{ matrix.target }}"
          fi

      - name: Strip binary (native)
        if: "!matrix.cross && runner.os != 'Windows'"
        shell: bash
        run: |
          bin="target/${{ matrix.target }}/release/lock"
          if command -v strip >/dev/null; then
            case "${{ runner.os }}" in
              macOS) strip -x "${bin}" ;;
              *)     strip "${bin}" ;;
            esac
          fi

      - name: Install cross-strip toolchain (Linux aarch64)
        if: matrix.cross
        run: sudo apt-get update && sudo apt-get install -y binutils-aarch64-linux-gnu

      - name: Strip binary (cross)
        if: matrix.cross
        run: aarch64-linux-gnu-strip target/${{ matrix.target }}/release/lock

      - name: Package archive (tar.gz)
        if: matrix.archive == 'tar.gz'
        shell: bash
        run: |
          set -euo pipefail
          version="${{ github.event.inputs.version }}"
          target="${{ matrix.target }}"
          staging="lock-${version}-${target}"
          mkdir -p "${staging}"
          cp "target/${target}/release/lock" "${staging}/"
          cp README.md LICENSE* "${staging}/" 2>/dev/null || true
          tar czf "${staging}.tar.gz" "${staging}"
          echo "ARCHIVE=${staging}.tar.gz" >> "${GITHUB_ENV}"

      - name: Package archive (zip)
        if: matrix.archive == 'zip'
        shell: bash
        run: |
          set -euo pipefail
          version="${{ github.event.inputs.version }}"
          target="${{ matrix.target }}"
          staging="lock-${version}-${target}"
          mkdir -p "${staging}"
          cp "target/${target}/release/lock.exe" "${staging}/"
          cp README.md LICENSE* "${staging}/" 2>/dev/null || true
          7z a "${staging}.zip" "${staging}"
          echo "ARCHIVE=${staging}.zip" >> "${GITHUB_ENV}"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: archive-${{ matrix.target }}
          path: ${{ env.ARCHIVE }}
          if-no-files-found: error
          retention-days: 1

  release:
    name: Create release with artifacts
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: archive-*
          merge-multiple: true

      - name: Generate SHA256SUMS
        shell: bash
        run: |
          set -euo pipefail
          cd artifacts
          sha256sum lock-* > SHA256SUMS
          echo "--- SHA256SUMS ---"
          cat SHA256SUMS

      - name: Sign SHA256SUMS with cosign (keyless)
        shell: bash
        run: |
          set -euo pipefail
          cosign sign-blob --yes \
            --output-signature artifacts/SHA256SUMS.sig \
            --output-certificate artifacts/SHA256SUMS.pem \
            artifacts/SHA256SUMS

      - name: Generate SBOM (SPDX JSON)
        uses: anchore/sbom-action@v0
        with:
          path: .
          format: spdx-json
          output-file: artifacts/lock-${{ github.event.inputs.version }}.sbom.spdx.json
          upload-artifact: "false"
          upload-release-assets: "false"

      - name: Attest build provenance
        id: provenance
        uses: actions/attest-build-provenance@v2
        with:
          subject-checksums: artifacts/SHA256SUMS

      - name: Collect provenance bundle artifact
        shell: bash
        run: |
          set -euo pipefail
          cp "${{ steps.provenance.outputs.bundle-path }}" "artifacts/lock-${{ github.event.inputs.version }}.provenance.intoto.jsonl"

      - name: Create annotated tag if missing
        shell: bash
        run: |
          set -euo pipefail
          version="${{ github.event.inputs.version }}"
          tag="v${version}"
          if git rev-parse "${tag}" >/dev/null 2>&1; then
            echo "Tag ${tag} already exists. Reusing existing tag."
          else
            git tag -a "${tag}" -m "lock ${tag}"
            git push origin "${tag}"
          fi

      - name: Create or update GitHub release with artifacts
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          version="${{ github.event.inputs.version }}"
          tag="v${version}"
          if gh release view "${tag}" >/dev/null 2>&1; then
            echo "Release ${tag} exists. Uploading artifacts to existing release."
            gh release upload "${tag}" artifacts/* --clobber
          else
            gh release create "${tag}" artifacts/* \
              --verify-tag \
              --title "lock ${tag}" \
              --notes "Release ${tag}"
          fi

  homebrew:
    name: Update Homebrew tap
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Download SHA256SUMS from release
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          version="${{ github.event.inputs.version }}"
          tag="v${version}"
          gh release download "${tag}" --pattern "SHA256SUMS" --dir .
          cat SHA256SUMS

      - name: Generate Homebrew formula
        shell: bash
        run: |
          set -euo pipefail
          version="${{ github.event.inputs.version }}"
          repo="${{ github.repository }}"
          base_url="https://github.com/${repo}/releases/download/v${version}"

          # Extract checksums for each platform.
          macos_arm_sha=$(grep "aarch64-apple-darwin" SHA256SUMS | awk '{print $1}')
          macos_intel_sha=$(grep "x86_64-apple-darwin" SHA256SUMS | awk '{print $1}')
          linux_sha=$(grep "x86_64-unknown-linux-gnu" SHA256SUMS | awk '{print $1}')
          linux_arm_sha=$(grep "aarch64-unknown-linux-gnu" SHA256SUMS | awk '{print $1}')

          cat > lock.rb <<FORMULA
          class Lock < Formula
            desc "Pin artifacts, fingerprints, and tool versions into a self-hashed dataset lockfile"
            homepage "https://github.com/${repo}"
            version "${version}"
            license "MIT"

            on_macos do
              if Hardware::CPU.arm?
                url "${base_url}/lock-${version}-aarch64-apple-darwin.tar.gz"
                sha256 "${macos_arm_sha}"
              else
                url "${base_url}/lock-${version}-x86_64-apple-darwin.tar.gz"
                sha256 "${macos_intel_sha}"
              end
            end

            on_linux do
              if Hardware::CPU.arm?
                url "${base_url}/lock-${version}-aarch64-unknown-linux-gnu.tar.gz"
                sha256 "${linux_arm_sha}"
              else
                url "${base_url}/lock-${version}-x86_64-unknown-linux-gnu.tar.gz"
                sha256 "${linux_sha}"
              end
            end

            def install
              bin.install "lock"
            end

            test do
              assert_match "lock ${version}", shell_output("#{bin}/lock --version")
            end
          end
          FORMULA

          # Strip leading whitespace from heredoc indentation.
          sed -i 's/^          //' lock.rb
          echo "--- Generated formula ---"
          cat lock.rb

      - name: Push formula to Homebrew tap
        env:
          TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          version="${{ github.event.inputs.version }}"
          tap_repo="cmdrvl/homebrew-tap"

          if [[ -z "${TAP_TOKEN:-}" ]]; then
            echo "HOMEBREW_TAP_TOKEN secret not configured. Skipping tap update."
            exit 0
          fi

          git clone "https://x-access-token:${TAP_TOKEN}@github.com/${tap_repo}.git" tap
          mkdir -p tap/Formula
          cp lock.rb tap/Formula/lock.rb

          cd tap
          # Check if formula content changed.
          if git diff --quiet -- Formula/lock.rb 2>/dev/null; then
            echo "Formula unchanged. No-op."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/lock.rb
          git commit -m "lock ${version}"
          git push origin HEAD

  publish:
    name: Publish to crates.io
    if: ${{ github.event.inputs.publish == 'true' }}
    runs-on: ubuntu-latest
    needs: preflight
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install stable Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Publish package
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: cargo publish --locked
